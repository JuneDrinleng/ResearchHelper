<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <!--#include virtual="theme-init.html" -->

    <meta charset="UTF-8" />
    <title>设置 - ResearchHelper</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        padding: 40px;
        max-width: 800px;
        margin: auto;
        transition: background-color 0.3s, color 0.3s;
      }

      h1 {
        text-align: center;
        font-size: 36px;
        margin-bottom: 20px;
      }

      .top-nav {
        text-align: left;
        margin-bottom: 20px;
      }

      .top-nav a {
        display: inline-block;
        padding: 8px 16px;
        background-color: #e0e0e0;
        color: #333;
        text-decoration: none;
        border-radius: 4px;
        font-size: 14px;
      }

      .top-nav a:hover {
        background-color: #ccc;
      }

      label {
        display: block;
        font-weight: bold;
        margin-top: 20px;
      }

      input[type="text"],
      select {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        font-size: 16px;
      }

      button {
        margin-top: 30px;
        padding: 12px 30px;
        background-color: #0078d7;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
      }

      button:hover {
        background-color: #005a9e;
      }

      .footer {
        text-align: center;
        margin-top: 40px;
        font-size: 14px;
      }

      /* ====== 浅色模式 ====== */
      body.light-mode {
        background-color: #f9fafc;
        color: #000;
      }

      /* ====== 深色模式 ====== */
      body.dark-mode {
        background-color: #1e1e1e;
        color: #eee;
      }

      body.dark-mode label,
      body.dark-mode h1 {
        color: #fff;
      }

      body.dark-mode input,
      body.dark-mode select {
        background-color: #2e2e2e;
        color: #fff;
        border: 1px solid #555;
      }

      body.dark-mode .top-nav a {
        background-color: #444;
        color: #eee;
      }

      body.dark-mode .top-nav a:hover {
        background-color: #666;
      }

      body.dark-mode .footer {
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <h1>设置</h1>

    <form>
      <label for="theme">界面主题</label>
      <select id="theme" name="theme">
        <option value="system">跟随系统</option>
        <option value="light">浅色</option>
        <option value="dark">深色</option>
      </select>
      <label for="autostart">
        <input type="checkbox" id="autostart" />
        开机时自动启动 ResearchHelper
      </label>
      <button id="checkUpdate">检查更新</button>
      <p id="updateStatus" style="margin-top: 8px; font-size: 14px"></p>
    </form>

    <div class="footer">ResearchHelper | From June Drinleng</div>

    <script>
      const { electronAPI } = window;
      const themeSelect = document.getElementById("theme");
      const autostartCheckbox = document.getElementById("autostart");

      function applyTheme(theme) {
        document.body.classList.remove("light-mode", "dark-mode");

        let finalTheme = theme;
        if (theme === "system") {
          const prefersDark = window.matchMedia(
            "(prefers-color-scheme: dark)"
          ).matches;
          finalTheme = prefersDark ? "dark" : "light";
        }

        document.body.classList.add(finalTheme + "-mode");
      }

      document.addEventListener("DOMContentLoaded", () => {
        // 主题设置
        let savedTheme = localStorage.getItem("theme") || "system";
        themeSelect.value = savedTheme;
        applyTheme(savedTheme);
        themeSelect.addEventListener("change", (e) => {
          const selectedTheme = e.target.value;
          localStorage.setItem("theme", selectedTheme);
          applyTheme(selectedTheme);
        });

        // 自动启动设置
        const savedAutostart = localStorage.getItem("autostart");
        if (savedAutostart !== null) {
          autostartCheckbox.checked = savedAutostart === "true";
        }

        ipcRenderer.invoke("get-autostart").then((enabled) => {
          if (savedAutostart === null) {
            autostartCheckbox.checked = enabled;
          }
        });

        autostartCheckbox.addEventListener("change", () => {
          const enabled = autostartCheckbox.checked;
          ipcRenderer.send("set-autostart", enabled);
          localStorage.setItem("autostart", enabled);
        });
      });

      // 监听系统主题变化
      const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
      mediaQuery.addEventListener("change", () => {
        if (localStorage.getItem("theme") === "system") {
          applyTheme("system");
        }
      });
      const checkUpdateBtn = document.getElementById("checkUpdate");
      const updateStatus = document.getElementById("updateStatus");

      checkUpdateBtn.addEventListener("click", () => {
        updateStatus.textContent = "正在检查更新…";
        ipcRenderer.send("check-for-updates"); // 发给主进程
      });

      /* 主进程回传进度（可选，美化体验） */
      ipcRenderer.on("update-status", (_e, msg) => {
        updateStatus.textContent = msg;
      });
    </script>
  </body>
</html>
